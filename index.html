<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BarneyTube & SpotSocial Search+Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* … your existing styles … */
  </style>
</head>
<body>

  <h1>BarneyTube & SpotSocial</h1>

  <section class="search-section" id="spotify-search-section">
    <h2>Search Spotify Tracks</h2>
    <input type="text" id="spotify-query" placeholder="Enter track or artist name" />
    <button id="spotify-search-btn">Search Spotify</button>
    <div class="results" id="spotify-results"></div>
    <div id="spotify-player"></div>
  </section>

  <section class="search-section" id="youtube-search-section">
    <h2>Search YouTube Videos</h2>
    <input type="text" id="youtube-query" placeholder="Enter video title or keywords" />
    <button id="youtube-search-btn">Search YouTube</button>
    <div class="results" id="youtube-results"></div>
    <div id="youtube-player"></div>
  </section>

  <script type="module">
    import { config } from './config.js';
    import { createSpotifyPlayer } from './Player/spotifyPlayer.js';
    import { createYouTubePlayer } from './Player/youtubePlayer.js';

    let spotifyToken = null;

    // Now calling your backend instead of using the secret client‑side
    async function getSpotifyAccessToken() {
      const res = await fetch('/api/spotify-token'); 
      if (!res.ok) throw new Error('Spotify token error');
      const { access_token } = await res.json();
      return access_token;
    }

    async function searchSpotify(query, token) {
      const res = await fetch(
        `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      if (!res.ok) throw new Error('Spotify search error');
      return (await res.json()).tracks.items;
    }

    async function searchYouTube(query) {
      const res = await fetch(
        `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(query)}&key=${config.GOOGLE_API_KEY}`
      );
      if (!res.ok) throw new Error('YouTube search error');
      return (await res.json()).items;
    }

    // DOM refs
    const spotifyQueryInput = document.getElementById('spotify-query');
    const spotifySearchBtn   = document.getElementById('spotify-search-btn');
    const spotifyResultsDiv  = document.getElementById('spotify-results');
    const spotifyPlayerDiv   = document.getElementById('spotify-player');

    const youtubeQueryInput  = document.getElementById('youtube-query');
    const youtubeSearchBtn   = document.getElementById('youtube-search-btn');
    const youtubeResultsDiv  = document.getElementById('youtube-results');
    const youtubePlayerDiv   = document.getElementById('youtube-player');

    // Spotify Search & Play
    spotifySearchBtn.onclick = async () => {
      const query = spotifyQueryInput.value.trim();
      if (!query) return;
      spotifyResultsDiv.innerHTML = 'Loading...';
      try {
        if (!spotifyToken) spotifyToken = await getSpotifyAccessToken();
        const tracks = await searchSpotify(query, spotifyToken);
        spotifyResultsDiv.innerHTML = tracks.length
          ? ''
          : 'No results found.';
        tracks.forEach(track => {
          const div = document.createElement('div');
          div.className = 'result-item';
          div.innerHTML = `
            <img src="${track.album.images[0]?.url||''}" alt="${track.name}" />
            <div>${track.name} — ${track.artists.map(a=>a.name).join(', ')}</div>
          `;
          div.onclick = () => createSpotifyPlayer('spotify-player', `spotify:track:${track.id}`);
          spotifyResultsDiv.appendChild(div);
        });
      } catch (e) {
        spotifyResultsDiv.innerHTML = `Error: ${e.message}`;
      }
    };

    // YouTube Search & Play
    youtubeSearchBtn.onclick = async () => {
      const query = youtubeQueryInput.value.trim();
      if (!query) return;
      youtubeResultsDiv.innerHTML = 'Loading...';
      try {
        const videos = await searchYouTube(query);
        youtubeResultsDiv.innerHTML = videos.length
          ? ''
          : 'No results found.';
        videos.forEach(video => {
          const vid     = video.id.videoId;
          const thumb   = video.snippet.thumbnails.high.url;
          const title   = video.snippet.title;
          const div     = document.createElement('div');
          div.className = 'result-item';
          div.innerHTML = `
            <img src="${thumb}" alt="${title}" />
            <div>${title}</div>
          `;
          div.onclick = () => createYouTubePlayer('youtube-player', vid, { autoplay: true });
          youtubeResultsDiv.appendChild(div);
        });
      } catch (e) {
        youtubeResultsDiv.innerHTML = `Error: ${e.message}`;
      }
    };
  </script>
</body>
</html>
